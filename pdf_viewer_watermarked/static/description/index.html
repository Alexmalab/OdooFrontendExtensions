<h1 id="pdf-viewer-watermark">PDF Viewer Watermark</h1>
<p><img src="https://img.shields.io/badge/maturity-Alpha-red.png" alt="Alpha">
<img src="https://img.shields.io/badge/licence-AGPL--3-blue.png" alt="license">
<a href="https://github.com/Alexmalab"><img src="https://img.shields.io/badge/Alexmalab-24292f.png?logo=github" alt="author"></a>
<a href="https://github.com/Alexmalab/OdooFrontendExtensions/tree/18.0/pdf_viewer_watermarked"><img src="https://img.shields.io/badge/OdooFrontendExtensions-f1f8ff.png?logo=github&amp;logoColor=0366d6" alt="repo"></a></p>
<h2 id="description">Description</h2>
<p>Allowing you preview pdf documents with watermarked text on it.</p>
<ul>
<li>2 widgets have been introduced:</li>
<li><code>pdf_viewer_wm</code>, field widget for binary(mimetype:pdf) fields<ul>
<li>Extended from <code>pdf_viewer</code>.</li>
<li>Generates watermarks via frontend methods.</li>
<li>Good performance and compatibility but less secure.</li>
</ul>
</li>
<li><code>pdf_watermark</code>, field widget for binary(mimetype:pdf) fields.<ul>
<li>Extended from <code>binary</code>.</li>
<li>Generates watermarked PDF file(backend methods) when downloaded.</li>
<li>Less compatible and bad performance with large file, not recommended.</li>
</ul>
</li>
<li>1 component have been introduced:</li>
<li><code>WatermarkedFileViewer</code>, enhanced version of <code>FileViewer</code> component<ul>
<li>Add watermark feature for viewing pdf file.</li>
</ul>
</li>
</ul>
<h2 id="usage">Usage</h2>
<ol>
<li><p><code>pdf_viewer_wm</code>:</p>
<pre><code class="lang-xml">&lt;!--add <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">option</span> <span class="hljs-title">enable</span> <span class="hljs-title">you</span> <span class="hljs-title">set</span> <span class="hljs-title">the</span> <span class="hljs-title">height</span> <span class="hljs-title">value</span> <span class="hljs-title">of</span> <span class="hljs-title">the</span> <span class="hljs-title">viewer</span> <span class="hljs-title">container</span></span>
 <span class="hljs-class"><span class="hljs-keyword">class</span></span>=<span class="hljs-string">"h-screen"</span> <span class="hljs-comment">//full screen</span>
 <span class="hljs-class"><span class="hljs-keyword">class</span></span>=<span class="hljs-string">"half-screen"</span> <span class="hljs-comment">// half screen  </span>
 <span class="hljs-class"><span class="hljs-keyword">class</span></span>=<span class="hljs-string">"h-300"</span> <span class="hljs-comment">//300px</span>
 <span class="hljs-class"><span class="hljs-keyword">class</span></span>=<span class="hljs-string">"h-500"</span> <span class="hljs-comment">//500px</span>

 --&gt;
&lt;field name=<span class="hljs-string">"binary_field"</span> widget=<span class="hljs-string">"pdf_viewer_wm"</span> <span class="hljs-class"><span class="hljs-keyword">class</span></span>=<span class="hljs-string">"h-screen"</span>/&gt;
</code></pre>
<p><strong>Effect Preview:</strong>
<img src="preview1.png" alt="Effect Preview" width="1200"></p>
</li>
<li><code>pdf_watermark</code>: <pre><code class="lang-xml">&lt;field <span class="hljs-built_in">name</span>=<span class="hljs-string">"binary_field"</span> widget=<span class="hljs-string">"pdf_watermark"</span>/&gt;
</code></pre>
</li>
<li><p>An example of using the component <code>WatermarkedFileViewer</code>: </p>
<pre><code class="lang-javascript"><span class="hljs-keyword">import</span> { KanbanRecord } <span class="hljs-keyword">from</span> <span class="hljs-string">"@web/views/kanban/kanban_record"</span>;
<span class="hljs-keyword">import</span> { useFileViewer } <span class="hljs-keyword">from</span> <span class="hljs-string">"@web/core/file_viewer/file_viewer_hook"</span>;
<span class="hljs-keyword">import</span> { WatermarkedFileViewer } <span class="hljs-keyword">from</span> <span class="hljs-string">"@pdf_viewer_watermarked/components/watermarked_file_viewer/watermarked_file_viewer"</span>;
<span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">XxDocumentKanbanRecord</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">KanbanRecord</span> </span>{
 setup() {
     <span class="hljs-keyword">super</span>.setup();
     <span class="hljs-keyword">this</span>.fileViewer = useFileViewer();
 }
}
<span class="hljs-keyword">let</span> id = <span class="hljs-number">1</span>;  <span class="hljs-comment">// 为每个viewer生成唯一ID</span>
patch(VesselDocumentKanbanRecord.prototype, {
 setup() {
     <span class="hljs-keyword">super</span>.setup();

     <span class="hljs-keyword">const</span> originalOpen = <span class="hljs-keyword">this</span>.fileViewer.open;
     <span class="hljs-keyword">this</span>.fileViewer.open = <span class="hljs-function">(<span class="hljs-params">file, files = [file]</span>) =&gt;</span> {
         <span class="hljs-keyword">if</span> (file.isPdf) {
             <span class="hljs-comment">// so far this component only render pdf file</span>
             <span class="hljs-keyword">this</span>.openWithWatermark(file, files);
         } <span class="hljs-keyword">else</span> {
             originalOpen(file, files);
         }
     };
 },

 openWithWatermark(file, files) {
     <span class="hljs-keyword">if</span> (!file.isViewable) {
         <span class="hljs-keyword">return</span>;
     }
     <span class="hljs-keyword">const</span> viewableFiles = files.filter(<span class="hljs-function">(<span class="hljs-params">file</span>) =&gt;</span> file.isViewable);
     <span class="hljs-keyword">const</span> index = viewableFiles.indexOf(file);
     <span class="hljs-keyword">const</span> fileViewerId = <span class="hljs-string">`web.file_viewer<span class="hljs-subst">${id++}</span>`</span>;

     registry.category(<span class="hljs-string">"main_components"</span>).add(fileViewerId, {
         <span class="hljs-attr">Component</span>: WatermarkedFileViewer,
         <span class="hljs-attr">props</span>: {
             <span class="hljs-attr">files</span>: viewableFiles,
             <span class="hljs-attr">startIndex</span>: index,
             <span class="hljs-attr">close</span>: <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
                 registry.category(<span class="hljs-string">"main_components"</span>).remove(fileViewerId);
             }
         },
     });
 }
});
</code></pre>
<p><strong>Effect Preview:</strong>
<img src="preview2.gif" alt="Effect Preview"></p>
<h2 id="bug-tracker">Bug Tracker</h2>
<p>Bugs are tracked on <a href="https://github.com/Alexmalab/OdooFrontendExtensions/issues">GitHub Issues</a>. In case of trouble, please check there if your issue has already been reported. If you spotted it first, help us to smash it by providing a detailed and welcomed feedback.</p>
</li>
</ol>
<h2 id="credits">Credits</h2>
<h3 id="authors">Authors</h3>
<ul>
<li><a href="https://github.com/Alexmalab">Alexandre Ma</a></li>
</ul>
<h3 id="contributors">Contributors</h3>
<ul>
<li>Alexandre Ma<a href="&#x6d;&#97;&#x69;&#x6c;&#116;&#111;&#58;&#x5b;&#x61;&#108;&#101;&#120;&#46;&#109;&#97;&#64;&#x68;&#97;&#x74;&#99;&#x68;&#x74;&#101;&#x63;&#x2e;&#x63;&#x6f;&#x6d;&#93;&#x28;&#x6d;&#x61;&#105;&#108;&#x74;&#111;&#x3a;&#97;&#x31;&#101;&#120;&#x6d;&#x61;&#x40;&#x68;&#x6f;&#x74;&#109;&#97;&#105;&#x6c;&#46;&#99;&#111;&#x6d;&#x29;">&#x5b;&#x61;&#108;&#101;&#120;&#46;&#109;&#97;&#64;&#x68;&#97;&#x74;&#99;&#x68;&#x74;&#101;&#x63;&#x2e;&#x63;&#x6f;&#x6d;&#93;&#x28;&#x6d;&#x61;&#105;&#108;&#x74;&#111;&#x3a;&#97;&#x31;&#101;&#120;&#x6d;&#x61;&#x40;&#x68;&#x6f;&#x74;&#109;&#97;&#105;&#x6c;&#46;&#99;&#111;&#x6d;&#x29;</a></li>
</ul>
<h3 id="copyright">Copyright</h3>
<p>The copyright of this module belongs to <a href="https://github.com/Alexmalab">Alexandre Ma</a></p>
<h2 id="license">License</h2>
<ul>
<li><img src="https://img.shields.io/badge/licence-AGPL--3-blue.png" alt="license"></li>
</ul>
